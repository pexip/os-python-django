From e5ea2842941967f06cefa10865f303b39c95279f Mon Sep 17 00:00:00 2001
From: Adam Johnson <me@adamj.eu>
Date: Fri, 2 Sep 2022 09:44:05 +0100
Subject: [PATCH] Fixed CVE-2022-41323 -- Prevented locales being interpreted
 as regular expressions.

Thanks to Benjamin Balder Bach for the report.
---
 django/urls/resolvers.py     | 2 +-
 tests/i18n/patterns/tests.py | 6 ++++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/django/urls/resolvers.py b/django/urls/resolvers.py
index 3f8f6c00ea89..109c412fd225 100644
--- a/django/urls/resolvers.py
+++ b/django/urls/resolvers.py
@@ -289,7 +289,7 @@ class LocalePrefixPattern:
     @property
     def regex(self):
         # This is only used by reverse() and cached in _reverse_dict.
-        return re.compile(self.language_prefix)
+        return re.compile(re.escape(self.language_prefix))
 
     @property
     def language_prefix(self):
diff --git a/tests/i18n/patterns/tests.py b/tests/i18n/patterns/tests.py
index 6ed2c4ffebd6..c3d0a22c9304 100644
--- a/tests/i18n/patterns/tests.py
+++ b/tests/i18n/patterns/tests.py
@@ -234,6 +234,12 @@ class URLRedirectTests(URLTestCaseBase):
         response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='en')
         self.assertRedirects(response, '/en/account/register/', 301)
 
+    def test_locale_not_interepreted_as_regex(self):
+        with translation.override("e("):
+            # Would previously error:
+            # re.error: missing ), unterminated subpattern at position 1
+            reverse("users")
+
 
 class URLVaryAcceptLanguageTests(URLTestCaseBase):
     """
