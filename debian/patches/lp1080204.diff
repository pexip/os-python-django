Origin: backport, b774c5993cf80000966ae8f04c985116f98ee5ac
Description: Isolated poisoned_http_host tests from 500 handlers
Bug: https://code.djangoproject.com/ticket/19172
Bug-Ubuntu: https://launchpad.net/bugs/1080204

Index: python-django-1.3.1/django/contrib/auth/tests/views.py
===================================================================
--- python-django-1.3.1.orig/django/contrib/auth/tests/views.py	2012-11-19 16:27:29.000000000 -0600
+++ python-django-1.3.1/django/contrib/auth/tests/views.py	2012-11-19 16:31:25.000000000 -0600
@@ -96,7 +96,11 @@
                 HTTP_HOST='www.example:dr.frankenstein@evil.tld'
             )
         self.assertRaises(SuspiciousOperation, test_host_poisoning)
-        self.assertEqual(len(mail.outbox), 0)
+        # Skip any 500 handler action (like sending more mail...)
+        # if ADMINS or MANAGERS is defined
+        if settings.ADMINS and len(settings.ADMINS) == 0 and \
+           settings.MANAGERS and len(settings.MANAGERS) == 0:
+            self.assertEqual(len(mail.outbox), 0)
 
     def test_poisoned_http_host_admin_site(self):
         "Poisoned HTTP_HOST headers can't be used for reset emails on admin views"
@@ -106,7 +110,11 @@
                 HTTP_HOST='www.example:dr.frankenstein@evil.tld'
             )
         self.assertRaises(SuspiciousOperation, test_host_poisoning)
-        self.assertEqual(len(mail.outbox), 0)
+        # Skip any 500 handler action (like sending more mail...)
+        # if ADMINS or MANAGERS is defined
+        if settings.ADMINS and len(settings.ADMINS) == 0 and \
+           settings.MANAGERS and len(settings.MANAGERS) == 0:
+            self.assertEqual(len(mail.outbox), 0)
 
     def _test_confirm_start(self):
         # Start by creating the email
